<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gest√£o de Alunos - Escola One</title>
  <link rel="stylesheet" href="design-system.css">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body {
      background: hsl(var(--background));
      margin: 0;
      overflow-x: hidden;
    }

    /* Header */
    .header {
      background: hsl(var(--card));
      border-bottom: 1px solid hsl(var(--border));
      padding: 1rem 2rem;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 70px;
      box-sizing: border-box;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .logo {
      width: 50px;
      height: 50px;
      border-radius: calc(var(--radius) * 2);
      overflow: hidden;
      background: hsl(var(--primary) / 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .brand-text {
      font-size: 1.5rem;
      font-weight: 700;
      color: hsl(var(--foreground));
    }

    .brand-text .brand {
      color: hsl(var(--primary));
    }

    .header-nav {
      display: flex;
      align-items: center;
      gap: 2rem;
    }

    .header-nav .nav-link {
      color: hsl(var(--muted-foreground));
      text-decoration: none;
      font-weight: 500;
      padding: 0.5rem 1rem;
      border-radius: var(--radius);
      transition: all 0.2s ease;
    }

    .header-nav .nav-link:hover {
      color: hsl(var(--primary));
      background: hsl(var(--primary) / 0.1);
    }

    /* Main Content */
    .main-content {
      margin-top: 70px;
      padding: 2rem;
      min-height: calc(100vh - 70px);
    }

    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .page-title-section {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .page-icon {
      width: 48px;
      height: 48px;
      background: hsl(var(--primary) / 0.1);
      color: hsl(var(--primary));
      border-radius: calc(var(--radius) * 1.5);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .page-icon svg {
      width: 24px;
      height: 24px;
    }

    .page-title {
      font-size: 2rem;
      font-weight: 700;
      color: hsl(var(--foreground));
      margin: 0;
    }

    .page-subtitle {
      color: hsl(var(--muted-foreground));
      font-size: 0.875rem;
      margin: 0.25rem 0 0 0;
    }

    /* Search and Filter Bar */
    .search-bar {
      background: hsl(var(--card));
      border: 1px solid hsl(var(--border));
      border-radius: calc(var(--radius) * 2);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .search-input {
      flex: 1;
      min-width: 250px;
    }

    .filter-select {
      min-width: 150px;
    }

    /* Students Table */
    .students-section {
      background: hsl(var(--card));
      border: 1px solid hsl(var(--border));
      border-radius: calc(var(--radius) * 2);
      overflow: hidden;
    }

    .table-header {
      padding: 1.5rem;
      border-bottom: 1px solid hsl(var(--border));
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .table-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: hsl(var(--foreground));
      margin: 0;
    }

    .table-container {
      overflow-x: auto;
    }

    .students-table {
      width: 100%;
      border-collapse: collapse;
    }

    .students-table th {
      background: hsl(var(--muted) / 0.5);
      color: hsl(var(--muted-foreground));
      padding: 1rem;
      text-align: left;
      font-weight: 600;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid hsl(var(--border));
    }

    .students-table td {
      padding: 1rem;
      border-bottom: 1px solid hsl(var(--border));
      vertical-align: middle;
    }

    .students-table tr:hover {
      background: hsl(var(--muted) / 0.3);
    }

    .students-table tr:last-child td {
      border-bottom: none;
    }

    .student-name {
      font-weight: 600;
      color: hsl(var(--foreground));
    }

    .student-id {
      font-size: 0.875rem;
      color: hsl(var(--muted-foreground));
      font-family: monospace;
    }

    .student-info {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    /* Action Buttons */
    .action-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .btn-icon {
      width: 32px;
      height: 32px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-icon svg {
      width: 16px;
      height: 16px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: hsl(var(--muted-foreground));
    }

    .empty-state svg {
      width: 80px;
      height: 80px;
      margin-bottom: 1rem;
      color: hsl(var(--muted-foreground) / 0.5);
    }

    .empty-state h3 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      color: hsl(var(--muted-foreground));
    }

    .empty-state p {
      margin-bottom: 1.5rem;
    }

    /* Loading State */
    .loading-state {
      text-align: center;
      padding: 2rem;
      color: hsl(var(--muted-foreground));
    }

    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid hsl(var(--muted));
      border-top: 3px solid hsl(var(--primary));
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
      .header-nav {
        display: none;
      }
    }

    @media (max-width: 768px) {
      .header {
        padding: 1rem;
      }

      .main-content {
        padding: 1rem;
      }

      .page-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .search-bar {
        flex-direction: column;
        align-items: stretch;
      }

      .search-input,
      .filter-select {
        min-width: auto;
      }

      .students-table {
        font-size: 0.875rem;
      }

      .students-table th,
      .students-table td {
        padding: 0.75rem 0.5rem;
      }
    }

    /* Mobile Menu Toggle */
    .mobile-menu-toggle {
      display: none;
      background: none;
      border: none;
      color: hsl(var(--foreground));
      cursor: pointer;
      padding: 0.5rem;
      border-radius: var(--radius);
    }

    @media (max-width: 1024px) {
      .mobile-menu-toggle {
        display: block;
      }
    }

    /* Header Navigation Responsive */
    @media (max-width: 1200px) {
      .header-nav {
        gap: 1rem;
      }
      
      .header-nav .nav-link {
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
      }
    }

    @media (max-width: 1024px) {
      .header-nav {
        display: none;
      }
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }

    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: hsl(var(--card));
      border: 1px solid hsl(var(--border));
      border-radius: calc(var(--radius) * 2);
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: scale(0.9) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid hsl(var(--border));
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: hsl(var(--foreground));
      margin: 0;
    }

    .modal-close {
      background: none;
      border: none;
      color: hsl(var(--muted-foreground));
      cursor: pointer;
      padding: 0.5rem;
      border-radius: var(--radius);
      transition: all 0.2s ease;
    }

    .modal-close:hover {
      background: hsl(var(--muted) / 0.5);
      color: hsl(var(--foreground));
    }

    .modal-body {
      padding: 1.5rem;
    }

    .modal-footer {
      padding: 1.5rem;
      border-top: 1px solid hsl(var(--border));
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    .error-message {
      color: hsl(var(--destructive));
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }

    .input.error,
    .select.error {
      border-color: hsl(var(--destructive));
      box-shadow: 0 0 0 2px hsl(var(--destructive) / 0.2);
    }

    @media (max-width: 768px) {
      .modal-content {
        width: 95%;
        margin: 1rem;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .modal-footer {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <button class="mobile-menu-toggle" onclick="toggleSidebar()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
     <div class="header-left">
      <div class="logo">
        <svg width="50" height="50" viewBox="0 0 50 50" fill="none" xmlns="http://www.w3.org/2000/svg">
          <!-- Background Circle -->
          <circle cx="25" cy="25" r="25" fill="url(#logoGradient)"/>
          
          <!-- Book Icon -->
          <path d="M15 18C15 16.8954 15.8954 16 17 16H33C34.1046 16 35 16.8954 35 18V32C35 33.1046 34.1046 34 33 34H17C15.8954 34 15 33.1046 15 32V18Z" fill="white" fill-opacity="0.9"/>
          <path d="M18 20H32V22H18V20Z" fill="hsl(220 14% 96%)"/>
          <path d="M18 24H28V26H18V24Z" fill="hsl(220 14% 96%)"/>
          <path d="M18 28H30V30H18V28Z" fill="hsl(220 14% 96%)"/>
          
          <!-- Graduation Cap -->
          <path d="M25 12L35 16L25 20L15 16L25 12Z" fill="white"/>
          <path d="M32 18V22C32 23.1046 28.4183 24 25 24C21.5817 24 18 23.1046 18 22V18" stroke="white" stroke-width="1.5" fill="none"/>
          
          <!-- Number "1" -->
          <circle cx="39" cy="12" r="6" fill="white" fill-opacity="0.9"/>
          <text x="39" y="16" font-family="Arial, sans-serif" font-size="8" font-weight="bold" fill="hsl(220 14% 20%)" text-anchor="middle">1</text>
          
          <!-- Gradient Definition -->
          <defs>
            <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#1d4ed8;stop-opacity:1" />
            </linearGradient>
          </defs>
        </svg>
      </div>
      <div class="brand-text">
        <span class="brand">Escola</span> One
      </div>
    </div>
      
    </div>

    <nav class="header-nav">
      <a href="painel.html" class="nav-link">Home</a>
      <a href="alunos.html" class="nav-link active">Alunos</a>
      <a href="encarregados.html" class="nav-link">Encarregados</a>
      <a href="professores.html" class="nav-link">Professores</a>
      <a href="disciplinas.html" class="nav-link">Disciplinas</a>
      <a href="turmas.html" class="nav-link">Turmas</a>
      <a href="horarios.html" class="nav-link">Hor√°rios</a>
      <a href="#" class="nav-link" onclick="if(confirm('Tem certeza que deseja sair do sistema?')) { authManager.logout(); } return false;">Logout</a>
    </nav>
  </header>


  <!-- Main Content -->
  <main class="main-content">
    <div class="page-header">
      <div class="page-title-section">
        <div class="page-icon">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 12c2.7 0 8 1.34 8 4v2H4v-2c0-2.66 5.3-4 8-4Zm0-2a4 4 0 1 1 0-8 4 4 0 0 1 0 8Z"/>
          </svg>
        </div>
        <div>
          <h1 class="page-title">Gest√£o de Alunos</h1>
          <p class="page-subtitle">Gerencie todos os alunos matriculados na escola</p>
        </div>
      </div>
      <button class="btn btn-primary" onclick="adicionarAluno()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/>
        </svg>
        Adicionar Aluno
      </button>
    </div>

    <!-- Search and Filter Bar -->
    <div class="search-bar">
      <input
        type="text"
        class="input search-input"
        placeholder="Pesquisar alunos por nome, bilhete ou telefone..."
        id="searchInput"
        oninput="filtrarAlunos()"
      >
      <select class="select filter-select" id="cursoFilter" onchange="filtrarAlunos()">
        <option value="">Todos os cursos</option>
        <!-- Op√ß√µes ser√£o carregadas dinamicamente -->
      </select>
      <select class="select filter-select" id="turmaFilter" onchange="filtrarAlunos()">
        <option value="">Todas as turmas</option>
        <!-- Op√ß√µes ser√£o carregadas dinamicamente -->
      </select>
      <button class="btn btn-outline" onclick="limparFiltros()" title="Limpar filtros">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
        </svg>
        Limpar
      </button>
    </div>

    <!-- Students Table -->
    <div class="students-section">
      <div class="table-header">
        <h2 class="table-title">Lista de Alunos</h2>
        <span id="studentsCount" class="badge badge-secondary">0 alunos</span>
      </div>

      <!-- Loading State -->
      <div class="loading-state" id="loadingState">
        <div class="spinner"></div>
        <p>Carregando alunos...</p>
      </div>

      <!-- Table Container -->
      <div class="table-container" id="tableContainer" style="display: none;">
        <table class="students-table">
          <thead>
            <tr>
              <th>Aluno</th>
               <th>Bilhete</th>
              <th>Data Nascimento</th>
              <th>Telefone</th>
              <!--<th>Bairro</th>-->
              <th>Curso</th>
              <th>Turma</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="studentsTableBody">
            <!-- Students will be inserted here -->
          </tbody>
        </table>
      </div>

      <!-- Empty State -->
      <div class="empty-state" id="emptyState" style="display: none;">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 12c2.7 0 8 1.34 8 4v2H4v-2c0-2.66 5.3-4 8-4Zm0-2a4 4 0 1 1 0-8 4 4 0 0 1 0 8Z"/>
        </svg>
        <h3>Nenhum aluno encontrado</h3>
        <p>N√£o h√° alunos cadastrados ou que correspondam aos filtros aplicados.</p>
        <button class="btn btn-primary" onclick="adicionarAluno()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/>
          </svg>
          Adicionar Primeiro Aluno
        </button>
      </div>
    </div>
  </main>

  <!-- Modal para Editar Aluno -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Editar Aluno</h3>
        <button class="modal-close" onclick="fecharModalEdicao()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <form id="editForm" class="form-grid">
          <div class="form-group">
            <label for="editNome" class="label">Nome Completo *</label>
            <input type="text" id="editNome" class="input" required>
            <span class="error-message" id="editNomeError"></span>
          </div>
          
          <div class="form-group">
            <label for="editDataNascimento" class="label">Data de Nascimento *</label>
            <input type="date" id="editDataNascimento" class="input" required>
            <span class="error-message" id="editDataNascimentoError"></span>
          </div>
          
          <div class="form-group">
            <label for="editNumeroBilhete" class="label">N√∫mero do Bilhete</label>
            <input type="text" id="editNumeroBilhete" class="input">
            <span class="error-message" id="editNumeroBilheteError"></span>
          </div>
          
          <div class="form-group">
            <label for="editTelefone" class="label">Telefone</label>
            <input type="tel" id="editTelefone" class="input">
            <span class="error-message" id="editTelefoneError"></span>
          </div>
          
         <!-- <div class="form-group">
            <label for="editBairro" class="label">Bairro</label>
            <input type="text" id="editBairro" class="input">
            <span class="error-message" id="editBairroError"></span>
          </div>-->
          
          <div class="form-group">
            <label for="editCurso" class="label">Curso *</label>
            <select id="editCurso" class="select" required>
              <option value="">Selecione o curso</option>
              <option value="Ensino Fundamental">Ensino Fundamental</option>
              <option value="Ensino M√©dio">Ensino M√©dio</option>
              <option value="Ensino T√©cnico">Ensino T√©cnico</option>
              <option value="Ensino Superior">Ensino Superior</option>
            </select>
            <span class="error-message" id="editCursoError"></span>
          </div>
          
          <div class="form-group">
            <label for="editTurma" class="label">Turma *</label>
            <select id="editTurma" class="select" required>
              <option value="">Selecione a turma</option>
              <option value="1¬∫ Ano A">1¬∫ Ano A</option>
              <option value="1¬∫ Ano B">1¬∫ Ano B</option>
              <option value="2¬∫ Ano A">2¬∫ Ano A</option>
              <option value="2¬∫ Ano B">2¬∫ Ano B</option>
              <option value="3¬∫ Ano A">3¬∫ Ano A</option>
              <option value="3¬∫ Ano B">3¬∫ Ano B</option>
            </select>
            <span class="error-message" id="editTurmaError"></span>
          </div>
          
         
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline" onclick="fecharModalEdicao()">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="salvarEdicaoAluno()">Salvar Altera√ß√µes</button>
      </div>
    </div>
  </div>

  <script>
    // Supabase Configuration
    const SUPABASE_URL = 'https://fsmnmggjklhxfkfnjxgc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZzbW5tZ2dqa2xoeGZrZm5qeGdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MDE0NTAsImV4cCI6MjA3MTE3NzQ1MH0.dMRH2DTAE8a1Vnyw9a8OiP5nTZetQy70hQgMV_a7jwo';
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let alunos = [];
    let alunosFiltrados = [];


    // Load students from Supabase
    async function carregarAlunos() {
      try {
        showLoading();
        
        const { data, error } = await supabaseClient
          .from('alunos')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) {
          throw error;
        }

        alunos = data || [];
        alunosFiltrados = [...alunos];
        
        // Carregar op√ß√µes de filtro dinamicamente
        await carregarOpcoesFiltragem();
        
        renderizarTabela();
        updateStudentsCount();
        
      } catch (error) {
        console.error('Erro ao carregar alunos:', error);
        showError('Erro ao carregar lista de alunos: ' + error.message);
      } finally {
        hideLoading();
      }
    }

    // Carregar op√ß√µes de filtragem dinamicamente
    async function carregarOpcoesFiltragem() {
      try {
        // Carregar cursos √∫nicos dos alunos
        const cursosUnicos = [...new Set(alunos.map(aluno => aluno.curso).filter(curso => curso))];
        const cursoSelect = document.getElementById('cursoFilter');
        
        // Limpar op√ß√µes existentes (exceto a primeira)
        cursoSelect.innerHTML = '<option value="">Todos os cursos</option>';
        
        // Adicionar op√ß√µes de cursos
        cursosUnicos.sort().forEach(curso => {
          const option = document.createElement('option');
          option.value = curso;
          option.textContent = curso;
          cursoSelect.appendChild(option);
        });

        // Carregar turmas √∫nicas dos alunos
        const turmasUnicas = [...new Set(alunos.map(aluno => aluno.turma).filter(turma => turma))];
        const turmaSelect = document.getElementById('turmaFilter');
        
        // Limpar op√ß√µes existentes (exceto a primeira)
        turmaSelect.innerHTML = '<option value="">Todas as turmas</option>';
        
        // Adicionar op√ß√µes de turmas
        turmasUnicas.sort().forEach(turma => {
          const option = document.createElement('option');
          option.value = turma;
          option.textContent = turma;
          turmaSelect.appendChild(option);
        });

        console.log('Filtros carregados:', { cursos: cursosUnicos, turmas: turmasUnicas });
        
      } catch (error) {
        console.error('Erro ao carregar op√ß√µes de filtragem:', error);
      }
    }

    // Format date
    function formatarData(dataISO) {
      if (!dataISO) return '';
      const data = new Date(dataISO);
      return data.toLocaleDateString('pt-BR');
    }

    // Render students table
    function renderizarTabela() {
      const tbody = document.getElementById('studentsTableBody');
      const tableContainer = document.getElementById('tableContainer');
      const emptyState = document.getElementById('emptyState');
      
      if (alunosFiltrados.length === 0) {
        tableContainer.style.display = 'none';
        emptyState.style.display = 'block';
        return;
      }
      
      emptyState.style.display = 'none';
      tableContainer.style.display = 'block';
      
      tbody.innerHTML = alunosFiltrados.map(aluno => `
        <tr>
          <td>
            <div class="student-info">
              <div class="student-name">${aluno.nome}</div>
            </div>
          </td>
          
            <td>${aluno.numero_bilhete || 'N/A'}</td>

          <td>${formatarData(aluno.data_nascimento)}</td>
          <td>${aluno.telefone || 'N/A'}</td>
         
          <td>
            <span class="badge badge-outline">${aluno.curso || 'N/A'}</span>
          </td>
          <td>
            <span class="badge badge-secondary">${aluno.turma || 'N/A'}</span>
          </td>
          <td>
            <div class="action-buttons">
              <button class="btn btn-outline btn-icon" onclick="editarAluno(${aluno.id})" title="Editar">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                </svg>
              </button>
              <button class="btn btn-destructive btn-icon" onclick="eliminarAluno(${aluno.id})" title="Eliminar">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                </svg>
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    // Filter students
    function filtrarAlunos() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
      const cursoFilter = document.getElementById('cursoFilter').value;
      const turmaFilter = document.getElementById('turmaFilter').value;

      alunosFiltrados = alunos.filter(aluno => {
        // Filtro de busca por texto (nome, bilhete, telefone)
        const matchesSearch = !searchTerm ||
          (aluno.nome && aluno.nome.toLowerCase().includes(searchTerm)) ||
          (aluno.numero_bilhete && aluno.numero_bilhete.toLowerCase().includes(searchTerm)) ||
          (aluno.telefone && aluno.telefone.toLowerCase().includes(searchTerm));

        // Filtro por curso
        const matchesCurso = !cursoFilter || aluno.curso === cursoFilter;
        
        // Filtro por turma
        const matchesTurma = !turmaFilter || aluno.turma === turmaFilter;

        return matchesSearch && matchesCurso && matchesTurma;
      });

      renderizarTabela();
      updateStudentsCount();
      
      // Log para debug
      console.log('Filtros aplicados:', {
        busca: searchTerm,
        curso: cursoFilter,
        turma: turmaFilter,
        resultados: alunosFiltrados.length
      });
    }

    // Limpar todos os filtros
    function limparFiltros() {
      document.getElementById('searchInput').value = '';
      document.getElementById('cursoFilter').value = '';
      document.getElementById('turmaFilter').value = '';
      
      // Recarregar todos os alunos
      alunosFiltrados = [...alunos];
      renderizarTabela();
      updateStudentsCount();
      
      console.log('Filtros limpos, mostrando todos os alunos:', alunos.length);
    }

    // Update students count
    function updateStudentsCount() {
      const count = alunosFiltrados.length;
      const countElement = document.getElementById('studentsCount');
      countElement.textContent = `${count} ${count === 1 ? 'aluno' : 'alunos'}`;
    }

    // Show loading state
    function showLoading() {
      document.getElementById('loadingState').style.display = 'block';
      document.getElementById('tableContainer').style.display = 'none';
      document.getElementById('emptyState').style.display = 'none';
    }

    // Hide loading state
    function hideLoading() {
      document.getElementById('loadingState').style.display = 'none';
    }

    // Show error
    function showError(message) {
      alert(message); // In a real app, you'd use a proper notification system
    }

    // Add student
    function adicionarAluno() {
      window.location.href = 'cadastrar-aluno.html';
    }

    // Edit student
    function editarAluno(id) {
      const aluno = alunos.find(a => a.id === id);
      if (!aluno) {
        alert('Aluno n√£o encontrado!');
        return;
      }

      // Preencher o formul√°rio com os dados do aluno
      document.getElementById('editNome').value = aluno.nome || '';
      document.getElementById('editDataNascimento').value = aluno.data_nascimento ? aluno.data_nascimento.split('T')[0] : '';
      document.getElementById('editNumeroBilhete').value = aluno.numero_bilhete || '';
      document.getElementById('editTelefone').value = aluno.telefone || '';
      //document.getElementById('editBairro').value = aluno.bairro || '';
      document.getElementById('editCurso').value = aluno.curso || '';
      document.getElementById('editTurma').value = aluno.turma || '';
      //document.getElementById('editEncarregado').value = aluno.encarregado || '';

      // Armazenar o ID do aluno sendo editado
      document.getElementById('editForm').dataset.alunoId = id;

      // Limpar erros anteriores
      limparErrosEdicao();

      // Mostrar o modal
      document.getElementById('editModal').classList.add('show');
    }

    // Fechar modal de edi√ß√£o
    function fecharModalEdicao() {
      document.getElementById('editModal').classList.remove('show');
      limparErrosEdicao();
    }

    // Limpar erros de edi√ß√£o
    function limparErrosEdicao() {
      const errorElements = document.querySelectorAll('#editModal .error-message');
      errorElements.forEach(element => {
        element.textContent = '';
      });

      const inputElements = document.querySelectorAll('#editModal .input, #editModal .select');
      inputElements.forEach(element => {
        element.classList.remove('error');
      });
    }

    // Validar campo de edi√ß√£o
    function validarCampoEdicao(campo, valor, mensagem) {
      const errorElement = document.getElementById(`edit${campo}Error`);
      const inputElement = document.getElementById(`edit${campo}`);
      
      if (!valor || valor.trim() === '') {
        errorElement.textContent = mensagem;
        inputElement.classList.add('error');
        return false;
      }
      
      errorElement.textContent = '';
      inputElement.classList.remove('error');
      return true;
    }

    // Salvar edi√ß√£o do aluno
    async function salvarEdicaoAluno() {
      const form = document.getElementById('editForm');
      const alunoId = parseInt(form.dataset.alunoId);

      // Obter valores do formul√°rio
      const nome = document.getElementById('editNome').value.trim();
      const dataNascimento = document.getElementById('editDataNascimento').value;
      const numeroBilhete = document.getElementById('editNumeroBilhete').value.trim();
      const telefone = document.getElementById('editTelefone').value.trim();
      //const bairro = document.getElementById('editBairro').value.trim();
      const curso = document.getElementById('editCurso').value;
      const turma = document.getElementById('editTurma').value;
      //const encarregado = document.getElementById('editEncarregado').value.trim();

      // Validar campos obrigat√≥rios
      let isValid = true;
      
      if (!validarCampoEdicao('Nome', nome, 'Nome √© obrigat√≥rio')) isValid = false;
      if (!validarCampoEdicao('DataNascimento', dataNascimento, 'Data de nascimento √© obrigat√≥ria')) isValid = false;
      if (!validarCampoEdicao('Curso', curso, 'Curso √© obrigat√≥rio')) isValid = false;
      if (!validarCampoEdicao('Turma', turma, 'Turma √© obrigat√≥ria')) isValid = false;

      if (!isValid) {
        return;
      }

      try {
        const alunoAtualizado = {
          nome,
          data_nascimento: dataNascimento,
          numero_bilhete: numeroBilhete,
          telefone,
          //bairro,
          curso,
          turma,
          
        };

        const { error } = await supabaseClient
          .from('alunos')
          .update(alunoAtualizado)
          .eq('id', alunoId);

        if (error) {
          throw error;
        }

        alert('Aluno atualizado com sucesso!');
        fecharModalEdicao();
        await carregarAlunos(); // Recarregar a lista
        
      } catch (error) {
        console.error('Erro ao atualizar aluno:', error);
        alert('Erro ao atualizar aluno: ' + error.message);
      }
    }

    // Delete student
    async function eliminarAluno(id) {
      const aluno = alunos.find(a => a.id === id);
      if (!aluno) return;

      if (!confirm(`Tem certeza que deseja eliminar o aluno "${aluno.nome}"?\n\nEsta a√ß√£o n√£o pode ser desfeita.`)) {
        return;
      }

      try {
        const { error } = await supabaseClient
          .from('alunos')
          .delete()
          .eq('id', id);

        if (error) {
          throw error;
        }

        alert('Aluno eliminado com sucesso!');
        await carregarAlunos(); // Reload the list
        
      } catch (error) {
        console.error('Erro ao eliminar aluno:', error);
        alert('Erro ao eliminar aluno: ' + error.message);
      }
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      carregarAlunos();
    });
  </script>

  <!-- Theme Manager -->
  <script src="theme-manager.js"></script>
</body>
</html>
